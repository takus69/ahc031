# [AHC031](https://atcoder.jp/contests/ahc031)

## 考察

- 日数D: 5 <= D <= 50(一様分布)
- 予約数N 5 <= N <= 50(一様分布)
- グリッドの縦横の長さW: W = 1,000
- 予約の面積a: (5/8)*W^2 <= Σa_d_i(d日の予約の面積の和) <= (799/800)*W^2
  - 予約の面積の和T_d: T_d = Σa_d_i, W^2-(3/2)*E <= T_d <= W^2-(1/2)*E
  - 平均空き面積E: E = W^2*e^2
    - パラメータe: 1/20 <= e <= 1/2
  - T_dより小さい整数をN-1出力して、ソート後その間隔をaとする
    - aの分布: 大きい方に裾野が広い形。平均は中央値より大きい。小さい方の裾野は狭い。Nは最大50で、ばらつきがある形でT_d上に分布する。値が小さいものはゼロに制限があるが、大きい方はNが50のため大きいものもそれなりに存在するということではないか。ガンマ分布とかで表現できる？とにかく、aがガツンと大きい値があるので、その対応をどうするかがキーになりそう(必ずパーティションの組み換えが発生し、もし組み換えしないとコストがかなりかかるはず)
  - T_dの分布: T_dの値は、3/4W^2からW^2まであるが、W^2に近い方が分布としては多い。初期シードの100件は3/4の分布が多めなため注意が必要。プレテストの100件も偏りがある可能性があるかも
- 平均空き面積が少ないと全部配置できない
- コスト
  - 予約の面積aを満たせないと、面積当たり100のコスト
  - 配置を変えて、パーティションを撤去・設置の長さ当たり1のコスト
    - 初日だけはコスト0
    - 外周はコスト0
- コスト改善の要素
  - 配置の最適化
  - 配置換えの最適化
- 最適化の手法
  - 配置を変えることで配置のコストが改善しないか(d日目のみで判定)
  - 配置を変えることで配置換えのコストが改善しないか(d-1, d, d+1日目で判定)
    - d-1, d+1の配置を変えないことで、それ以外に影響を与えない
    - 上記2つの最適化は、d日目の配置を変えることでトータルのコスト改善をみれば、山登りができる
- コスト計算の手法(ツールのコード見ると最適な算出方法で記載されてそう)
  - 配置のコストは、配置の面積と予約の面積の差分
  - 配置換えのコストは、縦と横それぞれでソート後コストを計算。縦と横のパーティションはそれぞれ高々D*2となる。前後を比較する際に左から順にみて、同じ軸の重なりを計算。それぞれO(N*2)程度
- 配置の妥当性
  - 配置は、重なりがないか。縦と横それぞれでソート後に重なりを確認するといいが、複数の長方形と比較する場合にどうするか？？？
- 初期配置
  - 大きい面積から配置を決めるのがよさそう
  - 形はどう決めるか？？？
    - 正方形に近い方が、面積に対するパーティションの数が少ないためコストが少なくなりやすいと考えられる
  - 案
    - とぐろをまく
    - タネを蒔いて、広げていって最適化
      - タネを蒔く: 等間隔で、とぐろを巻くように配置(初期はaの平均とする？)
      - 広げる: 各タネについて、大きくする、小さくする、移動するを試してコストが良くなるものを選択
        - 重なるのはNG(N分すべてチェック？)
        - 評価値はコストで最小化する。以下の面積とパーティションの和
          - 面積: 100*(予約の面積-実際の面積)
            - ただし、負になる場合は0
          - パーティション: 長方形の周りの長さ
            - ただし、外周は0、他と接する場合はその長さを1/2
        - 気持ち
          - 予約の面積を超えないとコストが大きい。予約の面積を超えて広げ過ぎるとパーティションが多くなりコストが増えるため、予約の面積に近い形になる
        - 実装方法
          - 4方向に広げる、4方向に移動する、4方向に小さくするの12パターンを試行して、一番評価値が良いパターンを採用
          - 接する、重なるを高速に評価する必要がある
- 配置の変更
  - 配置の変更はどのように見直すのが良いのか？？？
  - 案
    - 配置を最初に全て決めて、一つずつ前後の配置は変えずに配置の変更のコストを最小化するように最適化
    - 初期配置から初めて、次の配置、配置の変更のコストが最小になるように最適化
- 効率の良い配置
  - T_dの違いによって変化があるが、T_dが一定と仮定すると、aの分布は同じとなるはず。そのため、初期配置を使いまわせるのが一番効率が良い
  - 使いまわすと配置換えコストが0となる。ただし予約の面積から不足する分のコストがかかる場合がある
  - 平均空き面積Eが大きい場合は、余裕の持った面積の配置をすることでコスト0を実現できそう
  - コストに対する面積の増加分というパラメータを見るといいかも

## ToDo

- データ、ビジュアライザを確認
  - aの分布(Done)
  - T_d(aの和)の分布(Done)
  - Dごとのサンプルプログラムの配置
  - Tdの推測分布(Done)
- 構造体の設計
  - Room: パーティションで区切った部屋。面積を返す
  - Arrangement: ある日のRoomの配置。
  - Solution: 出力結果とコスト
- サンプルプログラム実装(Done)
  - バグあり(なぜか面積が小さいものがある)(reverseのタイミング間違っていた)(Done)
- 一括実行実装(Python?)(Done)
- スコア返却
- 配置の決定のコード
  - タネを蒔いて、広げていって最適化(Done)
- 配置を決めたうえで調整
  - 配置を最初に全て決めて、一つずつ前後の配置は変えずに配置の変更のコストを最小化するように最適化

## history
- v1: 一列に並べる(提出: 154,734,250)
- v2: 二列に並べる(提出: 86,547,256, 評価: 55,390,551, 評価(2000ケース): 65,177,622)
- v3: v2は全部埋めたが、最低限の領域にする(遊びがある状態)(提出: 79,630,613, 評価: 49,411,329)
- v4: 二列目の幅を二パターン試す(提出: 67,891,102, 評価: 41,727,169)
- v5: v4の四パターン(提出: 62,010,999, 評価: 37,782,008)
